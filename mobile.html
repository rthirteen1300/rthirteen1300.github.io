<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>行軍時間管理ツール（モバイル）</title>
<style>
  :root{--bg:#0f172a;--panel:#111827;--line:#1f2937;--muted:#94a3b8;--text:#e5e7eb;--acc:#22d3ee;--ok:#34d399;--warn:#fbbf24;--bad:#f87171}
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
  header{position:sticky;top:0;z-index:10;background:#0b1220;border-bottom:1px solid var(--line);padding:10px 12px}
  header h1{margin:0;font-size:16px;letter-spacing:.02em}
  main{max-width:480px;margin:0 auto;padding:10px 10px 92px 10px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0;overflow:hidden}
  .hint{color:var(--muted);font-size:12px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input,button{background:#0b1220;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px 10px;font-size:15px;outline:none;width:100%}
  input::placeholder{color:#64748b}
  input.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .inputs{display:grid;grid-template-columns:1fr;gap:10px}
  .tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .tools .spacer{flex:1}
  .btn{border-radius:10px;border:1px solid var(--line);padding:10px 12px;font-size:15px;width:100%}
  .btn-acc{background:var(--acc);color:#0b1220;border:none}
  .btn-ghost{background:transparent}
  .list-head{display:grid;grid-template-columns:24px minmax(0,1fr) 64px 96px 32px 28px;gap:4px;font-size:11px;color:var(--muted);margin-bottom:6px}
  .row{display:grid;grid-template-columns:24px minmax(0,1fr) 64px 96px 32px 28px;gap:4px;align-items:center;margin:6px 0}
  .idx{text-align:center;color:var(--muted)}
  .drag{cursor:grab;text-align:center}
  .rows-tools{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
  .summary{font-size:12px;color:var(--muted);margin-top:2px}
  .kpi{display:grid;gap:8px}
  .pill{border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;justify-content:space-between;gap:8px;background:#0b1220}
  .left{min-width:0}
  .left .name{font-size:15px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:58vw}
  .left .key{color:var(--muted);font-size:11px;margin-top:6px}
  .right{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px;text-align:right;white-space:nowrap}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .fixedbar{position:fixed;left:0;right:0;bottom:0;z-index:20;background:rgba(10,14,25,.96);backdrop-filter:saturate(120%) blur(8px);border-top:1px solid var(--line)}
  .fixedbar .inner{max-width:480px;margin:0 auto;padding:8px 10px;display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .num{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;text-align:center}
  .use h3{margin:0 0 6px 0;font-size:14px}
  .use ul{margin:0;padding-left:16px;line-height:1.6;font-size:13px}
  .use li{margin:2px 0}
</style>
</head>
<body>
<header><h1>行軍時間管理ツール</h1></header>
<main>
  <section class="card">
    <div class="inputs">
      <div>
        <label>基準の集結残り時間</label>
        <input id="baseRally" class="mono" type="text" placeholder="例 4:50 / 290" inputmode="numeric" pattern="[0-9:]*">
      </div>
      <div>
        <label>自分の行軍時間</label>
        <input id="myTime" class="mono" type="text" placeholder="例 0:30 / 30" inputmode="numeric" pattern="[0-9:]*">
      </div>
    </div>
    <div class="tools">
      <span id="snapInfo" class="hint">未スナップ</span>
      <span class="spacer"></span>
      <a href="./index.html?desktop=1" class="hint" style="text-decoration:underline">PC版で表示</a>
      <button class="btn btn-ghost" id="reset">入力の保存をクリア</button>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 6px 0;font-size:14px">集結者一覧</h3>
    <div class="list-head">
      <div>#</div><div>集結者</div><div>差(秒)</div><div>行軍(1:10/70)</div><div>↑↓</div><div>⠿</div>
    </div>
    <div id="rows"></div>
    <div class="rows-tools">
      <button class="btn btn-acc" id="addRow">＋ 行を追加</button>
      <button class="btn btn-ghost" id="clearRows">集結者を全消去</button>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 6px 0;font-size:14px">計算結果</h3>
    <div id="summary" class="summary">スナップすると結果が出ます。</div>
    <div id="cards" class="kpi"></div>
  </section>

  <section class="card use">
    <h3>使い方</h3>
    <ul>
      <li>(前提)集結者の行軍時間を把握します。</li>
      <li><b>基準とする任意の集結残り時間</b> を入力（例: <code>4:50</code> や <code>30</code>）。</li>
      <li><b>集結者の集結残り時間が基準時間になった直後に「スナップ（基準時間の設定）」</b> を押します。</li>
      <li><b>自分の行軍時間</b> を更新（例: <code>0:30</code> や <code>30</code>）。</li>
      <li><b>集結者一覧</b> に集結者名・基準との差（±秒）・行軍時間を入力。追加・削除や並べ替えができます。</li>
      <li><b>計算結果</b> に各行の行軍時間や到着時刻、出発判断（今！／待ち／着弾後到着）が表示されます。</li>
      <li><b>結果をコピー</b> で「集結者」「行軍時間」「到着時間」の3列をコピーできます。</li>
      <li>入力内容はブラウザに保存されます。「入力の保存をクリア」でリセット可能。</li>
    </ul>
  </section>
</main>

<div class="fixedbar">
  <div class="inner">
    <button class="btn btn-acc" id="snap">スナップ（基準時間の設定）</button>
    <button class="btn" id="copy">結果をコピー</button>
  </div>
</div>

<script>
(function(){
  const baseRallyEl=document.getElementById('baseRally');
  const myTimeEl=document.getElementById('myTime');
  const addRowBtn=document.getElementById('addRow');
  const clearRowsBtn=document.getElementById('clearRows');
  const rowsEl=document.getElementById('rows');
  const snapBtn=document.getElementById('snap');
  const snapInfo=document.getElementById('snapInfo');
  const cardsEl=document.getElementById('cards');
  const summaryEl=document.getElementById('summary');
  const copyBtn=document.getElementById('copy');
  const resetBtn=document.getElementById('reset');

  let lastSnap=null;
  let B_base=null;
  let items=[];
  let timer=null;

  const toInt=v=>Number.parseInt(v,10);
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

  function parseMMSS(s){
    if(s==null) return null;
    s=String(s).trim();
    if(s==='') return null;
    if(/^\d+:\d{1,2}$/.test(s)){
      const [m,ss]=s.split(':').map(n=>toInt(n));
      if(ss>=0&&ss<60) return m*60+ss;
      return null;
    }
    if(/^\d+$/.test(s)) return toInt(s);
    return null;
  }
  function fmtMMSS(total){
    const t=Math.max(0,Math.floor(total));
    const m=Math.floor(t/60),s=t%60;
    return `${m}:${String(s).padStart(2,'0')}`;
  }
  function fmtClock(date){
    const p=n=>String(n).padStart(2,'0');
    return `${p(date.getHours())}:${p(date.getMinutes())}:${p(date.getSeconds())}`;
  }
  function addSecs(date,secs){return new Date(date.getTime()+Math.floor(secs)*1000);}

  function save(){
    const data={
      baseRally:baseRallyEl.value,
      myTime:myTimeEl.value,
      rows:Array.from(rowsEl.querySelectorAll('.row.data')).map(r=>({
        name:r.querySelector('.name').value,
        diff:r.querySelector('.diff').value,
        march:r.querySelector('.march').value
      }))
    };
    localStorage.setItem('mobile_portrait_sync_v2',JSON.stringify(data));
  }
  function load(){
    const raw=localStorage.getItem('mobile_portrait_sync_v2');
    if(!raw){
      baseRallyEl.value='4:50';
      myTimeEl.value='0:30';
      addRow({name:'Aさん',diff:'0',march:'0:30'});
      addRow({name:'Bさん',diff:'2',march:'0:30'});
      return;
    }
    try{
      const d=JSON.parse(raw);
      baseRallyEl.value=d.baseRally||'';
      myTimeEl.value=d.myTime||'';
      rowsEl.innerHTML='';
      (d.rows||[]).forEach(addRow);
    }catch(e){}
  }

  function addRow(data={}){
    const idx=rowsEl.children.length+1;
    const row=document.createElement('div');
    row.className='row data';
    row.innerHTML=`
      <div class="idx">${idx}</div>
      <input class="name" placeholder="例 Aさん" value="${data.name||''}">
      <input class="diff mono num" type="number" step="1" placeholder="±秒" value="${data.diff??''}">
      <input class="march mono num" placeholder="1:10/70" value="${data.march||''}" inputmode="numeric" pattern="[0-9:]*">
      <button class="btn btn-ghost up" title="上へ">↑</button>
      <div class="drag" title="ドラッグで並べ替え" data-handle>⠿</div>
    `;
    row.querySelector('.up').insertAdjacentHTML('afterend',`<button class="btn btn-ghost down" title="下へ">↓</button>`);

    const handle=row.querySelector('[data-handle]');
    handle.setAttribute('draggable','true');
    handle.addEventListener('dragstart',e=>{
      row.classList.add('dragging');
      e.dataTransfer.effectAllowed='move';
      e.dataTransfer.setData('text/plain','');
    });
    handle.addEventListener('dragend',()=>{
      row.classList.remove('dragging');
      renumber();save();renderLive();
    });

    row.querySelector('.up').addEventListener('click',()=>{moveRow(row,-1);});
    row.querySelector('.down').addEventListener('click',()=>{moveRow(row,1);});
    ['input','change'].forEach(ev=>{
      row.querySelectorAll('input').forEach(el=>el.addEventListener(ev,()=>{save();renderLive();}));
    });
    rowsEl.appendChild(row);
  }

  function renumber(){Array.from(rowsEl.children).forEach((r,i)=>r.querySelector('.idx').textContent=i+1);}

  function moveRow(row,delta){
    const siblings=Array.from(rowsEl.children);
    const i=siblings.indexOf(row);
    const j=clamp(i+delta,0,siblings.length-1);
    if(i===j) return;
    rowsEl.insertBefore(row,(delta<0)?siblings[j]:siblings[j].nextSibling);
    renumber();save();renderLive();
  }

  rowsEl.addEventListener('dragover',e=>{
    e.preventDefault();
    const dragging=rowsEl.querySelector('.row.data.dragging'); if(!dragging) return;
    const after=getDragAfterElement(rowsEl,e.clientY);
    if(after==null) rowsEl.appendChild(dragging); else rowsEl.insertBefore(dragging,after);
  });

  function getDragAfterElement(container,y){
    const els=[...container.querySelectorAll('.row.data:not(.dragging)')];
    return els.reduce((closest,child)=>{
      const box=child.getBoundingClientRect(); const offset=y-box.top-box.height/2;
      if(offset<0&&offset>closest.offset) return {offset,element:child};
      return closest;
    },{offset:Number.NEGATIVE_INFINITY,element:null}).element;
  }

  function parseInputs(){
    const B=parseMMSS(baseRallyEl.value);
    if(B==null){alert('基準の「集結残り時間」が正しくありません（例 4:50 / 290）');return null;}
    const M0=parseMMSS(myTimeEl.value);
    if(M0==null){alert('自分の行軍時間が正しくありません（例 0:30 / 30）');return null;}
    const rows=Array.from(rowsEl.querySelectorAll('.row.data')).map(r=>{
      const name=r.querySelector('.name').value||'(集結者)';
      const diffStr=r.querySelector('.diff').value;
      const diff=diffStr===''?0:toInt(diffStr);
      const march=parseMMSS(r.querySelector('.march').value);
      return {name,diff,march};
    });
    for(const it of rows){
      if(it.march==null){alert(`${it.name} の行軍時間が正しくありません（例 1:10 / 70）`);return null;}
      if(Number.isNaN(it.diff)){alert(`${it.name} の差（±秒）が正しくありません（整数）`);return null;}
    }
    return {B,M0,rows};
  }

  function snap(){
    const v=parseInputs(); if(!v) return;
    lastSnap=new Date();
    B_base=v.B;
    items=v.rows.map(r=>({...r}));
    document.activeElement&&document.activeElement.blur();
    snapInfo.textContent=`スナップ: ${fmtClock(lastSnap)}（ローカル）`;
    renderOnce(v.M0);
    startTicker(v.M0);
  }

  function buildDepartState(departIn){
    if(departIn<-10) return `<span class="bad">【着弾後到着】</span>`;
    if(departIn<-0.5) return `<span class="bad">【着弾後到着】${fmtMMSS(-departIn)} 経過</span>`;
    if(departIn>0.5) return `<span class="warn">【待ち】${fmtMMSS(departIn)} 後</span>`;
    return `<span class="ok">【今！】</span>`;
  }

  function renderOnce(M0){
    const now=new Date();
    const dt=lastSnap?Math.floor((now-lastSnap)/1000):0;
    const data=items.map(it=>{
      const baseLeftAtSnap=B_base+it.diff;
      const leftNow=baseLeftAtSnap-dt;
      const timeToImpact=leftNow+it.march;
      const impactAt=addSecs(lastSnap||now,baseLeftAtSnap+it.march);
      const departAt=addSecs(lastSnap||now,baseLeftAtSnap+it.march-M0);
      const departIn=(baseLeftAtSnap+it.march-M0)-dt;
      return {...it,leftNow,timeToImpact,impactAt,departAt,departIn,baseLeftAtSnap};
    });
    const top2=[...data].sort((a,b)=>a.timeToImpact-b.timeToImpact).slice(0,2).map(x=>`${x.name}: ${fmtClock(x.impactAt)}`).join(' / ');
    summaryEl.innerHTML=data.length?`最短の到着予定：<b>${top2}</b>`:'集結者が未入力です';
    const html=data.map(d=>{
      const departState=buildDepartState(d.departIn);
      return `
        <div class="pill">
          <div class="left">
            <div class="name">${d.name}</div>
            <div class="key">あなた 出発時刻 / 判断</div>
            <div class="hint">${fmtClock(d.departAt)}　<span data-state>${departState}</span></div>
          </div>
          <div class="right">
            <div>行軍 ${fmtMMSS(d.march)}</div>
            <div>到着 ${fmtClock(d.impactAt)}</div>
            <div data-type="left">集結 ${fmtMMSS(d.leftNow)}</div>
            <div data-type="impact">残り ${fmtMMSS(d.timeToImpact)}</div>
          </div>
        </div>
      `;
    }).join('');
    cardsEl.innerHTML=html;
  }

  function startTicker(M0){
    if(timer) clearInterval(timer);
    timer=setInterval(()=>{
      if(!lastSnap||B_base==null) return;
      const now=new Date();
      const dt=Math.floor((now-lastSnap)/1000);
      const pills=[...cardsEl.querySelectorAll('.pill')];
      if(!pills.length) return;
      pills.forEach((pill,i)=>{
        const it=items[i];
        const baseLeftAtSnap=B_base+it.diff;
        const leftNow=baseLeftAtSnap-dt;
        const timeToImpact=leftNow+it.march;
        pill.querySelector('[data-type="left"]').textContent=`集結 ${fmtMMSS(leftNow)}`;
        pill.querySelector('[data-type="impact"]').textContent=`残り ${fmtMMSS(timeToImpact)}`;
        const departIn=(baseLeftAtSnap+it.march-M0)-dt;
        const stateEl=pill.querySelector('[data-state]');
        if(stateEl){
          const frozen=stateEl.dataset.frozen==='1';
          if(!frozen){
            if(departIn<-10){stateEl.innerHTML=`<span class="bad">【着弾後到着】</span>`;stateEl.dataset.frozen='1';}
            else stateEl.innerHTML=buildDepartState(departIn);
          }
        }
      });
    },250);
  }

  function renderLive(){
    if(!lastSnap||B_base==null) return;
    const B=parseMMSS(baseRallyEl.value);
    const M0=parseMMSS(myTimeEl.value);
    if(B==null||M0==null) return;
    B_base=B;
    items=Array.from(rowsEl.querySelectorAll('.row.data')).map(r=>({
      name:r.querySelector('.name').value||'(集結者)',
      diff:(r.querySelector('.diff').value===''?0:toInt(r.querySelector('.diff').value)),
      march:parseMMSS(r.querySelector('.march').value)
    })).filter(x=>x.march!=null&&!Number.isNaN(x.diff));
    renderOnce(M0);
    startTicker(M0);
  }

  function copyResult(){
    if(!cardsEl.children.length) return;
    const header=['集結者','行軍時間','到着時間'].join('\t');
    let text=header+'\n';
    items.forEach((it,idx)=>{
      const pill=cardsEl.children[idx];
      if(!pill) return;
      const name=pill.querySelector('.left .name')?.textContent?.trim()||it.name||'';
      const march=fmtMMSS(it.march);
      const impact=pill.querySelector('.right')?.textContent.match(/到着\s(\d{2}:\d{2}:\d{2})/)?.[1]||'';
      text+=[name,march,impact].join('\t')+'\n';
    });
    navigator.clipboard.writeText(text.trim());
    copyBtn.textContent='コピーしました';setTimeout(()=>copyBtn.textContent='結果をコピー',1200);
  }

  addRowBtn.addEventListener('click',()=>{addRow();save();});
  clearRowsBtn.addEventListener('click',()=>{rowsEl.innerHTML='';renumber();save();renderLive();});
  snapBtn.addEventListener('click',snap);
  copyBtn.addEventListener('click',copyResult);
  resetBtn.addEventListener('click',()=>{
    if(confirm('保存された入力を消去しますか？')){
      localStorage.removeItem('mobile_portrait_sync_v2');
      location.reload();
    }
  });

  [baseRallyEl,myTimeEl].forEach(el=>el.addEventListener('input',()=>{save();renderLive();}));
  rowsEl.addEventListener('input',()=>{save();renderLive();});
  rowsEl.addEventListener('touchmove',e=>{if(rowsEl.querySelector('.row.data.dragging')) e.preventDefault();},{passive:false});

  load();
})();
</script>
</body>
</html>
